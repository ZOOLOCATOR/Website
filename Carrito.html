<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Style</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.css">
    <script src="https://www.paypal.com/sdk/js?client-id=ASbCrjH7ghk7md94mZ3dWfJOymGj1a1v7MKFk22QmMOcfoZJNTtI7UKKTOQWFgUHdLptHWhdOQFBDtqJ&currency=USD"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .light-mode {
            background-color: white;
            color: black;
        }
        .dark-mode {
            background-color: black;
            color: white;
        }
        .nav-links a {
            text-decoration: none;
            padding: 10px;
            transition: color 0.3s;
        }
        .light-mode .nav-links a {
            color: rgb(255, 255, 255);
        }
        .dark-mode .nav-links a {
            color: lightblue;
        }
        .toggle-button {
            margin: 30px;
            padding: 0px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 24px;
        }
        .cart-count {
            position: absolute;
            top: 0;
            right: 0;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 0.2em 0.5em;
            font-size: 0.8rem;
        }

    </style>
</head>
<body>
    <!-- Barra de navegación -->
   
<header>
    <nav class="navbar">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="navbar-toggler" type="button" id="menu-toggle">
                    &#9776; <!-- Icono hamburguesa -->
                </button>
                <div class="logo ms-2">Dream Style</div>
            </div>
            <ul class="nav-links" id="nav-links">
                <li><a href="Index.html">Inicio</a></li>
                <li><a href="Hombres.html">Hombres</a></li>
                <li><a href="Mujeres.html">Mujeres</a></li>
                <li><a href="Niños.html">Niños</a></li>
                <li><a href="Contacto.html">Contacto</a></li>
            </ul>
            <button class="toggle-button" id="toggleButton" title="Cambiar a Modo Oscuro">
                🌞
            </button>
            <div class="cart-icon">
                <a href="Carrito.html">
                    <i class="ri-shopping-cart-fill" style="font-size: 1.5rem; cursor: pointer;"></i>
                    <span class="cart-count" id="cart-count">0</span>
                </a>
            </div>
        </div>
    </nav>
</header>
<link rel="stylesheet" href="styles.css">
<script>
    // JavaScript para abrir/cerrar el menú hamburguesa
    document.getElementById("menu-toggle").onclick = function() {
        document.getElementById("nav-links").classList.toggle("open");
    };
</script>
    <div class="productos">
        <h2>Carrito de Compras</h2>
        <p id="total-products" style="font-weight: bold;">Total de productos: <span id="product-count">0</span></p>
        <table class="table table-bordered" style="max-width: 90%; margin: auto; font-size: 0.8rem;">
            <thead>
                <tr>
                    <th>Imagen</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Sub Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="cart-tbody">
                <!-- Aquí se agregarán dinámicamente los productos del carrito -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL</td>
                    <td colspan="2" id="total-amount" style="text-align: center; font-size: 1.5rem; font-weight: bold;">$0.00</td>
                </tr>
                <tr>
                    <td colspan="6" style="text-align: center; padding-top: 20px;">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#checkout-container">Proceder a la compra</button>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
<!-- Pie de página -->
<footer>
    <p>2024 Dream Style. Todos los derechos reservados.<a href="Terminos y condiciones.html" class="terminos-link">Términos y Condiciones</a></p>
    <div class="redes">
        <a href="https://www.facebook.com/" target="_blank"><i class="ri-facebook-circle-fill"></i></a>
        <a href="https://www.instagram.com/" target="_blank"><i class="ri-instagram-fill"></i></a>
        <a href="https://www.whatsapp.com/" target="_blank"><i class="ri-whatsapp-line"></i></a>
    </div>
</footer>
  <!-- Modal de compra -->
  <div class="modal fade" id="checkout-container" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="checkoutModalLabel">Formulario de Compra</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="checkoutPurchaseForm">
                  <div class="mb-3">
                      <label class="form-label" for="checkoutNombre">Nombre Completo:</label>
                      <input class="form-control" id="checkoutNombre" required type="text">
                  </div>
                  <div class="mb-3">
                      <label class="form-label" for="checkoutEmail">Correo Electrónico:</label>
                      <input class="form-control" id="checkoutEmail" required type="email">
                  </div>
                  <div class="mb-3">
                      <label class="form-label" for="checkoutEmail">Dirección:</label>
                      <input class="form-control" id="checkoutDireccion" required type="text">
                      <div class="mb-3">
                        <label>
                            <input type="checkbox" id="acceptTerms" required>
                            Acepto los <a href="Terminos y condiciones.html" target="_blank">términos y condiciones</a>.
                        </label>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-primary" id="finalizarCompraBtn">Continuar Compra</button>
                    </div>
              </form>
          </div>
      </div>
  </div>
</div>

<div class="modal fade" id="payment-modal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Elige cómo pagar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="paypal-button-container" class="mt-3"></div>
                <button id="generateTicketBtn" class="btn btn-secondary" style="display: none;">Generar Ticket</button>
                <button id="finalizarBtn" class="btn btn-success mt-3" style="display: none;">Finalizar</button>
            </div>
        </div>
    </div>
</div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBLClY7hqBhBy-1qLTgjcnTxI3i-rvasDA",
          authDomain: "dreamstyle-56d32.firebaseapp.com",
          databaseURL: "https://dreamstyle-56d32-default-rtdb.firebaseio.com",
          projectId: "dreamstyle-56d32",
          storageBucket: "dreamstyle-56d32.firebasestorage.app",
          messagingSenderId: "188421473202",
          appId: "1:188421473202:web:424beeea5a4b6d507b5aab",
          measurementId: "G-D9REDB493L"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        
        document.addEventListener('DOMContentLoaded', () => {
    const finalizarCompraBtn = document.getElementById('finalizarCompraBtn');
    const paymentModal = new bootstrap.Modal(document.getElementById('payment-modal'));
    const cartCount = document.getElementById('cart-count');
    const acceptTerms = document.getElementById('acceptTerms');
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    let transactionCode = '';
    const checkoutModal = new bootstrap.Modal(document.getElementById('checkout-container'));

    // Actualizar número del carrito
    function updateCartCount() {
        const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
        cartCount.textContent = totalItems;
    }

    // Función para generar un código de transacción único
    let codigoTransaccion = ''; // Variable global para el código de transacción

function generateTransactionCode() {
    return `TX-${Math.floor(Math.random() * 1000000)}`;
}

async function savePaymentDetails(paymentMethod) {
    const nombre = document.getElementById('checkoutNombre').value;
    const email = document.getElementById('checkoutEmail').value;
    const direccion = document.getElementById('checkoutDireccion').value;
    const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);

    codigoTransaccion = generateTransactionCode(); // Generar y asignar el código único
    const newPaymentRef = ref(database, 'Pagos/' + codigoTransaccion);

    await set(newPaymentRef, {
        transactionCode: codigoTransaccion,
        paymentMethod,
        nombreCompleto: nombre,
        email,
        direccion,
        items: cartItems,
        total,
        fecha: new Date().toLocaleString()
    });

}

    
// Limpieza del carrito después de la compra
function clearCart() {
    cartItems.length = 0; // Vaciar el array local
    localStorage.removeItem('cart'); // Eliminar datos de localStorage
    renderCart(); // Actualizar la interfaz del carrito
    updateCartCount(); // Actualizar el contador del carrito
    console.log("Carrito limpiado después de la compra.");
}

// Función para actualizar el contador de productos en el carrito
function updateCartCount() {
    const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('cart-count').textContent = totalItems;
}

// Agregar botón para generar el ticket
document.addEventListener('DOMContentLoaded', () => {
    const generateTicketButton = document.getElementById('generateTicketBtn');
    if (generateTicketButton) {
        generateTicketButton.addEventListener('click', () => {
            generarPDF();
            console.log('Ticket generado manualmente.');
        });
    }
});

// Función para mostrar el botón "Finalizar" después de la compra
function mostrarFinalizarBtn() {
    const finalizarBtn = document.getElementById('finalizarBtn');
    finalizarBtn.style.display = 'block'; // Mostrar el botón
    finalizarBtn.addEventListener('click', () => {
        paymentModal.hide(); // Cerrar el modal de pago
        checkoutModal.hide(); // Cerrar el modal de compra
        alert('Gracias por tu compra. ¡Ahora puedes elegir otro producto!');
    });
}

// Ajuste en PayPal para mostrar el botón "Finalizar" después de la compra
paypal.Buttons({
    createOrder: function (data, actions) {
        const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2);
        return actions.order.create({
            purchase_units: [{ amount: { value: total } }]
        });
    },
    onApprove: async function (data, actions) {
        try {
            const details = await actions.order.capture(); // Captura el pago exitoso
            await savePaymentDetails('PayPal'); // Guarda los detalles en Firebase

            alert(`Pago completado con éxito. Descargando el ticket...`);

            descargarTicket(); // Generar el ticket
            clearCart(); // Limpia el carrito después del pago

            mostrarFinalizarBtn(); // Mostrar el botón "Finalizar"
        } catch (error) {
            console.error("Error al procesar el pago:", error);
            alert("Hubo un problema al completar el pago. Intenta nuevamente.");
        }
    },
    onError: function (err) {
        console.error("Error con PayPal:", err);
        alert("Error al procesar el pago. Intenta nuevamente.");
    }
}).render('#paypal-button-container');


function descargarTicket() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Datos del formulario
    const codigoTransaccion = "TX123456789"; 
    const nombre = document.getElementById('checkoutNombre').value || "Cliente";
    const email = document.getElementById('checkoutEmail').value || "Email no proporcionado";
    const fecha = new Date().toLocaleDateString();

    // Encabezado
    doc.setFontSize(18);
    doc.text("Dream Style - Ticket de Compra", 105, 20, { align: "center" });
    doc.setFontSize(12);
    doc.text(`Código de Transacción: ${codigoTransaccion}`, 10, 30); // Usar el código global
    doc.text(`Nombre: ${nombre}`, 10, 50);
    doc.text(`Email: ${email}`, 10, 60);
    doc.text(`Fecha: ${fecha}`, 10, 40);

    // Línea divisoria
    doc.line(10, 65, 200, 65);

    // Tabla de productos
    doc.text("Productos:", 10, 75);
    let y = 85;
    doc.setFontSize(10);

    // Encabezados de tabla
    doc.setFont("helvetica", "bold");
    doc.text("Producto", 10, y);
    doc.text("Precio Unit.", 90, y, { align: "right" });
    doc.text("Cant.", 120, y, { align: "right" });
    doc.text("Subtotal", 200, y, { align: "right" });
    y += 10;

    doc.setFont("helvetica", "normal");
    let total = 0;
    cartItems.forEach(item => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        doc.text(item.name, 10, y); // Producto
        doc.text(`$${item.price.toFixed(2)}`, 90, y, { align: "right" }); // Precio unitario
        doc.text(`${item.quantity}`, 120, y, { align: "right" }); // Cantidad
        doc.text(`$${subtotal.toFixed(2)}`, 200, y, { align: "right" }); // Subtotal
        y += 10;
    });

    // Línea divisoria antes del total
    doc.line(10, y, 200, y);
    y += 10;

    // Total
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Total:", 140, y, { align: "right" });
    doc.text(`$${total.toFixed(2)}`, 200, y, { align: "right" });

    // Pie de página
    y += 20;
    doc.setFontSize(10);
    doc.setFont("helvetica", "italic");
    doc.text("Gracias por tu compra, esperamos verte pronto :)", 105, y, { align: "center" });
    doc.text("www.dreamstyle.com", 105, y + 10, { align: "center" });

    // Generar código de barras
    const canvas = document.createElement("canvas");
    JsBarcode(canvas, codigoTransaccion, { format: "CODE128", width: 2, height: 50 });
    const barcodeImage = canvas.toDataURL("image/png");

    // Agregar el código de barras al PDF
    doc.addImage(barcodeImage, "PNG", 75, y + 20, 100, 50); // Ajusta las coordenadas y tamaño según sea necesario
    // Guardar el archivo PDF
    doc.save(`ticket_${codigoTransaccion}.pdf`);
}



document.getElementById('generateTicketBtn').addEventListener('click', descargarTicket);


    // Manejador para "Finalizar Compra"
    finalizarCompraBtn.addEventListener('click', () => {
        if (!acceptTerms.checked) {
            alert('Debe aceptar los términos y condiciones para continuar.');
            return;
        }

        paymentModal.show();
    });
            function removeExpiredItems() {
                // Recuperar los productos del carrito desde localStorage
                const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
                const now = Date.now(); // Obtener el tiempo actual en milisegundos

                // Filtrar los productos cuyo tiempo en el carrito sea menor o igual a 20 minutos
                const updatedCart = cartItems.filter(item => now - item.addedAt <= 5 * 60 * 1000);

                // Si la cantidad de productos cambia, actualizar el localStorage y el carrito
                if (updatedCart.length !== cartItems.length) {
                    localStorage.setItem('cart', JSON.stringify(updatedCart)); // Guardar el carrito actualizado
                    renderCart(); // Actualizar la interfaz del carrito
                }
            }

            // Llamar a la función `removeExpiredItems` periódicamente cada minuto
            setInterval(removeExpiredItems, 60 * 1000);


             // Renderizar carrito
    function renderCart() {
        const tbody = document.getElementById('cart-tbody');
        tbody.innerHTML = '';
        let totalAmount = 0;

        cartItems.forEach((item, index) => {
            const subtotal = item.price * item.quantity;
            totalAmount += subtotal;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${item.image}" style="width: 50px;"></td>
                <td>${item.name}</td>
                <td>$${item.price.toFixed(2)}</td>
                <td><input type="number" value="${item.quantity}" min="20" onchange="updateQuantity(${index}, this.value)"></td>
                <td>$${subtotal.toFixed(2)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">Eliminar</button></td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('total-amount').textContent = `$${totalAmount.toFixed(2)}`;
        updateCartCount();
    }

    // Función para actualizar la cantidad de un producto en el carrito
    window.updateQuantity = function (index, quantity) {
        cartItems[index].quantity = parseInt(quantity, 10);
        localStorage.setItem('cart', JSON.stringify(cartItems));
        renderCart();
    };

    // Función para eliminar un producto del carrito
    window.removeFromCart = function (index) {
        cartItems.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cartItems));
        renderCart();
    };

    // Función para agregar un producto al carrito
    window.addToCart = function (name, price, image) {
        const existingItem = cartItems.find(item => item.name === name);

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cartItems.push({ name, price, quantity: 1, image, addedAt: Date.now() });
        }

        localStorage.setItem('cart', JSON.stringify(cartItems));
        renderCart();
        alert(`${name} ha sido añadido al carrito.`);
    };

    // Inicializar
    renderCart();
});
</script>

    </script>
    <script src="script.js"></script>

    <script src="https://www.paypal.com/sdk/js?client-id=TUPUBLICCLIENTID&currency=USD"></script>

</body>
</html>
